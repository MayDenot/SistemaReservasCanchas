services:
  # ===========================
  # ========== DATABASE =======
  # ===========================
  postgres:
    image: postgres:15-alpine
    container_name: reservas-postgres
    env_file: .env
    environment:
      POSTGRES_MULTIPLE_DATABASES: ${POSTGRES_MULTIPLE_DATABASES}
      POSTGRES_USER: ${POSTGRES_ROOT_USER}
      POSTGRES_PASSWORD: ${POSTGRES_ROOT_PASSWORD}
    ports:
      - "${POSTGRES_PORT}:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init-scripts:/docker-entrypoint-initdb.d
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_ROOT_USER}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    restart: unless-stopped
    networks:
      - reservas-network

  # ===========================
  # ===== USER MICROSERVICE ===
  # ===========================
  user-service:
    build:
      context: .
      dockerfile: Dockerfile
    volumes:
      - ~/.m2:/root/.m2
    container_name: user-service
    env_file: .env
    ports:
      - "${USER_SERVICE_PORT}:8080"
    environment:
      SPRING_PROFILES_ACTIVE: docker

      DB_URL: ${USER_DB_URL}
      DB_USERNAME: ${USER_DB_USERNAME}
      DB_PASSWORD: ${USER_DB_PASSWORD}

      JWT_SECRET: ${JWT_SECRET}
      JWT_TOKEN_VALIDITY: ${JWT_TOKEN_VALIDITY}

      SERVER_PORT: ${USER_SERVICE_PORT}
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - reservas-network
    restart: unless-stopped

  # ===========================
  # ===== CLUB MICROSERVICE ===
  # ===========================
  club-service:
    build:
      context: .
      dockerfile: Dockerfile
    volumes:
      - ~/.m2:/root/.m2
    container_name: club-service
    env_file: .env
    ports:
      - "${CLUB_SERVICE_PORT}:8080"
    environment:
      SPRING_PROFILES_ACTIVE: docker

      DB_URL: ${CLUB_DB_URL}
      DB_USERNAME: ${CLUB_DB_USERNAME}
      DB_PASSWORD: ${CLUB_DB_PASSWORD}

      USER_SERVICE_URL: http://user-service:8080

      SERVER_PORT: ${CLUB_SERVICE_PORT}
    depends_on:
      postgres:
        condition: service_healthy
      user-service:
        condition: service_healthy
    networks:
      - reservas-network
    restart: unless-stopped

  # ===========================
  # ===== COURT MICROSERVICE ==
  # ===========================
  court-service:
    build:
      context: .
      dockerfile: Dockerfile
    volumes:
      - ~/.m2:/root/.m2
    container_name: court-service
    env_file: .env
    ports:
      - "${COURT_SERVICE_PORT}:8080"
    environment:
      SPRING_PROFILES_ACTIVE: docker

      DB_URL: ${COURT_DB_URL}
      DB_USERNAME: ${COURT_DB_USERNAME}
      DB_PASSWORD: ${COURT_DB_PASSWORD}

      CLUB_SERVICE_URL: http://club-service:8080
      USER_SERVICE_URL: http://user-service:8080

      SERVER_PORT: ${COURT_SERVICE_PORT}
    depends_on:
      postgres:
        condition: service_healthy
      club-service:
        condition: service_healthy
      user-service:
        condition: service_healthy
    networks:
      - reservas-network
    restart: unless-stopped

  # ===========================
  # === RESERVATION SERVICE ===
  # ===========================
  reservation-service:
    build:
      context: .
      dockerfile: Dockerfile
    volumes:
      - ~/.m2:/root/.m2
    container_name: reservation-service
    env_file: .env
    ports:
      - "${RESERVATION_SERVICE_PORT}:8080"
    environment:
      SPRING_PROFILES_ACTIVE: docker

      DB_URL: ${RESERVATION_DB_URL}
      DB_USERNAME: ${RESERVATION_DB_USERNAME}
      DB_PASSWORD: ${RESERVATION_DB_PASSWORD}

      USER_SERVICE_URL: http://user-service:8080
      CLUB_SERVICE_URL: http://club-service:8080
      COURT_SERVICE_URL: http://court-service:8080

      JWT_SECRET: ${JWT_SECRET}
      JWT_TOKEN_VALIDITY: ${JWT_TOKEN_VALIDITY}

      SERVER_PORT: ${RESERVATION_SERVICE_PORT}
    depends_on:
      postgres:
        condition: service_healthy
      user-service:
        condition: service_healthy
      club-service:
        condition: service_healthy
      court-service:
        condition: service_healthy
    networks:
      - reservas-network
    restart: unless-stopped

  # ===========================
  # ===== PAYMENT SERVICE =====
  # ===========================
  payment-service:
    build:
      context: .
      dockerfile: Dockerfile
    volumes:
      - ~/.m2:/root/.m2
    container_name: payment-service
    env_file: .env
    ports:
      - "${PAYMENT_SERVICE_PORT}:8080"
    environment:
      SPRING_PROFILES_ACTIVE: docker

      DB_URL: ${PAYMENT_DB_URL}
      DB_USERNAME: ${PAYMENT_DB_USERNAME}
      DB_PASSWORD: ${PAYMENT_DB_PASSWORD}

      USER_SERVICE_URL: http://user-service:8080
      RESERVATION_SERVICE_URL: http://reservation-service:8080

      JWT_SECRET: ${JWT_SECRET}
      JWT_TOKEN_VALIDITY: ${JWT_TOKEN_VALIDITY}

      SERVER_PORT: ${PAYMENT_SERVICE_PORT}
    depends_on:
      postgres:
        condition: service_healthy
      reservation-service:
        condition: service_healthy
      user-service:
        condition: service_healthy
    networks:
      - reservas-network
    restart: unless-stopped

  # ===============================
  # === NOTIFICATION MICROSERVICE =
  # ===============================
  notification-service:
    build:
      context: .
      dockerfile: Dockerfile
    volumes:
      - ~/.m2:/root/.m2
    container_name: notification-service
    env_file: .env
    ports:
      - "${NOTIFICATION_SERVICE_PORT}:8080"
    environment:
      SPRING_PROFILES_ACTIVE: docker

      DB_URL: ${NOTIFICATION_DB_URL}
      DB_USERNAME: ${NOTIFICATION_DB_USERNAME}
      DB_PASSWORD: ${NOTIFICATION_DB_PASSWORD}

      USER_SERVICE_URL: http://user-service:8080
      RESERVATION_SERVICE_URL: http://reservation-service:8080
      PAYMENT_SERVICE_URL: http://payment-service:8080

      SERVER_PORT: ${NOTIFICATION_SERVICE_PORT}
    depends_on:
      postgres:
        condition: service_healthy
      user-service:
        condition: service_healthy
    networks:
      - reservas-network
    restart: unless-stopped

  # ===========================
  # ======== API GATEWAY ======
  # ===========================
  api-gateway:
    build:
      context: .
      dockerfile: Dockerfile
    volumes:
      - ~/.m2:/root/.m2
    container_name: api-gateway
    env_file: .env
    ports:
      - "${GATEWAY_PORT}:8080"
    environment:
      SPRING_PROFILES_ACTIVE: docker

      USER_SERVICE_URL: http://user-service:8080
      CLUB_SERVICE_URL: http://club-service:8080
      COURT_SERVICE_URL: http://court-service:8080
      RESERVATION_SERVICE_URL: http://reservation-service:8080
      PAYMENT_SERVICE_URL: http://payment-service:8080
      NOTIFICATION_SERVICE_URL: http://notification-service:8080

      JWT_SECRET: ${JWT_SECRET}
      JWT_TOKEN_VALIDITY: ${JWT_TOKEN_VALIDITY}

      SERVER_PORT: ${GATEWAY_PORT}
    depends_on:
      - user-service
      - club-service
      - court-service
      - reservation-service
      - payment-service
      - notification-service
    networks:
      - reservas-network
    restart: unless-stopped

# =====================================
# ========= NETWORKS & VOLUMES ========
# =====================================
networks:
  reservas-network:
    driver: bridge
    name: reservas-network

volumes:
  postgres_data:
    driver: local
